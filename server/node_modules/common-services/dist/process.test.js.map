{"version":3,"sources":["../src/process.test.ts"],"names":["describe","log","jest","fn","savedProcessName","global","process","title","processListenerStub","spyOn","exit","exitPromise","fatalErrorDeferred","beforeEach","Promise","resolve","mockClear","mockReset","afterEach","done","NODE_ENV","PROCESS_NAME","$instance","destroy","$fatalError","promise","reject","then","catch","test","expect","mock","calls","toEqual","length","YError","find","call","forEach","signal","Knifecycle","register","initProcessService","run"],"mappings":"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","sourcesContent":["import YError from 'yerror';\nimport Knifecycle, { constant } from 'knifecycle';\nimport initProcessService from './process';\n\ndescribe('Process service', () => {\n  const log = jest.fn();\n  const savedProcessName = global.process.title;\n  const processListenerStub = jest.spyOn(global.process, 'on');\n  let exit;\n  let exitPromise;\n  let fatalErrorDeferred;\n\n  beforeEach(() => {\n    exitPromise = new Promise((resolve) => {\n      exit = jest.fn(resolve);\n    });\n    processListenerStub.mockClear();\n    log.mockReset();\n  });\n\n  afterEach(() => {\n    global.process.title = savedProcessName;\n  });\n\n  describe('', () => {\n    beforeEach((done) => {\n      initProcessService({\n        NODE_ENV: 'development',\n        PROCESS_NAME: 'Kikooolol',\n        log,\n        exit,\n        $instance: { destroy: () => Promise.resolve() } as Knifecycle<unknown>,\n        $fatalError: {\n          promise: new Promise((resolve, reject) => {\n            fatalErrorDeferred = { resolve, reject };\n          }),\n        },\n      })\n        .then(() => done())\n        .catch(done);\n    });\n\n    test('should work', () => {\n      expect(log.mock.calls).toEqual([\n        ['warning', 'ðŸ”‚ - Running in \"development\" environment.'],\n        ['debug', 'ðŸ“‡ - Process service initialized.'],\n      ]);\n      expect(global.process.title).toEqual('Kikooolol - development');\n      expect(processListenerStub.mock.calls.length).toEqual(3);\n    });\n\n    test('should handle fatal errors', (done) => {\n      fatalErrorDeferred.reject(new YError('E_AOUCH'));\n\n      exitPromise\n        .then(() => {\n          expect(exit.mock.calls).toEqual([[1]]);\n        })\n        .then(() => done())\n        .catch(done);\n    });\n\n    test('should handle uncaught exceptions', (done) => {\n      processListenerStub.mock.calls.find(\n        (call) => 'uncaughtException' === call[0],\n      )[1](new YError('E_AOUCH'));\n\n      exitPromise\n        .then(() => {\n          expect(exit.mock.calls).toEqual([[1]]);\n        })\n        .then(() => done())\n        .catch(done);\n    });\n\n    ['SIGINT', 'SIGTERM'].forEach((signal) =>\n      test('should handle `signal`', (done) => {\n        processListenerStub.mock.calls.find((call) => signal === call[0])[1](\n          new YError('E_AOUCH'),\n        );\n\n        exitPromise\n          .then(() => {\n            expect(exit.mock.calls).toEqual([[0]]);\n          })\n          .then(() => done())\n          .catch(done);\n      }),\n    );\n  });\n\n  test('should work with Knifecycle', (done) => {\n    new Knifecycle()\n      .register(initProcessService)\n      .register(constant('log', log))\n      .register(constant('NODE_ENV', 'production'))\n      .register(constant('exit', exit))\n      .run(['process'])\n      .then(() => {\n        expect(log.mock.calls).toEqual([\n          ['warning', 'ðŸ”‚ - Running in \"production\" environment.'],\n          ['debug', 'ðŸ“‡ - Process service initialized.'],\n        ]);\n      })\n      .then(() => done())\n      .catch(done);\n  });\n});\n"],"file":"process.test.js"}